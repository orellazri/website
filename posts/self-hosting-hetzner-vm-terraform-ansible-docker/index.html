<!DOCTYPE html>
<html lang="en" class="dark light">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https:&#x2F;&#x2F;orellazri.com">

    

    
    
    
    <title>
         Self Hosting On a Hetzner VM: Terraform, Ansible, Docker
        
    </title>

        
            <meta property="og:title" content="Self Hosting On a Hetzner VM: Terraform, Ansible, Docker" />
        
     

     
         
     

     
         
    

    
    
        <link rel="icon" type="image/png" href=&#x2F;favicon.svg />
    

    
    
        <link href=https://orellazri.com/fonts.css rel="stylesheet" />
    

    
    
        

        
            
            

            <script data-goatcounter="https://orellazri.goatcounter.com/count" async src="https://orellazri.com/js/count.js"></script>
            <noscript>
                
                <img src="https://orellazri.goatcounter.com//count?p=&#x2F;posts&#x2F;self-hosting-hetzner-vm-terraform-ansible-docker&#x2F;&t=Self Hosting On a Hetzner VM: Terraform, Ansible, Docker">
            </noscript>
        
    

    
    

    
    
        <script src=https://orellazri.com/js/toc.js></script>
    

    
    

    

    
    <link rel="alternate" type="application/atom+xml" title="Orel Lazri" href="https://orellazri.com/atom.xml">


    
    
        <link rel="stylesheet" type="text/css" href=https://orellazri.com/theme/light.css />
        <link rel="stylesheet" type="text/css" href="https://orellazri.com/theme/dark.css" media="(prefers-color-scheme: dark)" />
    

    <!-- Set the correct theme in the script -->
    <script src=https://orellazri.com/js/themetoggle.js></script>
    
        <script>
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                setTheme("dark");
            } else {
                setTheme("light");
            }
        </script>
    

    <link rel="stylesheet" type="text/css" media="screen" href=https://orellazri.com/main.css />

    

    <script src=https://orellazri.com/js/mermaid.js></script>

    <script defer src="https://orellazri.com/search_index.en.js?h=3a69812dc9773e8d3635"></script>
        <script defer src="https://orellazri.com/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script></head>


<body>
    <div class="content">
        <header>
    <div class="main">
        
            <a href=https:&#x2F;&#x2F;orellazri.com>Orel Lazri</a>
        


        <div class="socials">
            
            <a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;orellazri" class="social">
                <img alt=github src=https://orellazri.com/social_icons/github.svg>
            </a>
            
            <a rel="me" href="https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;orellazri" class="social">
                <img alt=linkedin src=https://orellazri.com/social_icons/linkedin.svg>
            </a>
            
        </div>
    </div>

    <nav>
        
            <a href=https://orellazri.com/posts style="margin-left: 0.25em">posts</a>
        
            <a href=https://orellazri.com/projects style="margin-left: 0.25em">projects</a>
        
            <a href=https://orellazri.com/atom.xml style="margin-left: 0.25em">rss</a>
        

        
        <button 
            id="search-button"
            class="search-button"
            title="$SHORTCUT to open search"
        >
            <img 
                src="https://orellazri.com/search.svg" 
                alt="Search" 
                class="search-icon"
            >
        </button>

        <div id="searchModal" class="search-modal js" role="dialog" aria-labelledby="modalTitle">
            <div id="modal-content">
                <h1 id="modalTitle" class="page-header">Search</h1>
                <div id="searchBar">
                    <input 
                        id="searchInput" 
                        role="combobox" 
                        autocomplete="off" 
                        spellcheck="false" 
                        aria-expanded="false" 
                        aria-controls="results-container" 
                        placeholder="Search..."
                    />
                    <button 
                        id="clear-search" 
                        class="clear-button"
                        title="Clear search"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                            <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/>
                        </svg>
                    </button>
                </div>
                <div id="results-container">
                    <div id="results-info">
                        <span id="zero_results" style="display: none;">No results</span>
                        <span id="one_result" style="display: none;">1 result</span>
                        <span id="many_results" style="display: none;">$NUMBER results</span>
                    </div>
                    <div id="results" role="listbox"></div>
                </div>
            </div>
        </div>
        

        
    </nav>
</header>


        
        
    
<main>
    <article>
        <div class="title">
            
            
    <div class="page-header">
        Self Hosting On a Hetzner VM: Terraform, Ansible, Docker<span class="primary-color" style="font-size: 1.6em">.</span>
    </div>


                <div class="meta">
                    
                        Posted on <time>2024-02-27</time>
                    

                    

                    

                    
                    
                            <span class="tags-label"> :: Tags:</span>
                            <span class="tags">
                                    <a href="https://orellazri.com/tags/devops/" class="post-tag">devops</a>
                                
                            </span>
                    

                    
                    

                    

                </div>
        </div>

        

        
        
        
            <div class="toc-container">
                <h1 class="toc-title">Table of Contents</h1>
                <ul class="toc-list">
                    
                        <li>
                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#using-terraform-to-provision-cloud-resources">Using Terraform to provision cloud resources</a>
                            
                        </li>
                    
                        <li>
                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#using-ansible-to-set-up-the-vm">Using Ansible to set up the VM</a>
                            
                                <ul>
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#configure-sshd">Configure sshd</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#install-docker">Install Docker</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#install-lazydocker">Install lazydocker</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#synchronize-docker-compose-directory">Synchronize docker compose directory</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#mount-hetzner-storage-box">Mount Hetzner Storage Box</a>
                                        </li>

                                        
                                    
                                </ul>
                            
                        </li>
                    
                        <li>
                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#crafting-docker-compose-files">Crafting Docker compose files</a>
                            
                                <ul>
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#nginx-proxy-manager">NGINX Proxy Manager</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#nextcloud">Nextcloud</a>
                                        </li>

                                        
                                    
                                        <li>
                                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#accessing-the-vm-from-outside">Accessing the VM from outside</a>
                                        </li>

                                        
                                            <ul>
                                                
                                                    <li>
                                                        <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#reverse-proxy">Reverse proxy</a>
                                                    </li>
                                                
                                            </ul>
                                        
                                    
                                </ul>
                            
                        </li>
                    
                        <li>
                            <a href="https://orellazri.com/posts/self-hosting-hetzner-vm-terraform-ansible-docker/#final-words">Final words</a>
                            
                        </li>
                    
                </ul>
            </div>
        
        

        <section class="body">
            <p>I started my self-hosting journey a few years back with a single desktop machine serving as both my NAS and the host for all the services I was running.</p>
<p>I found out the hard way, that sometimes it's not the best decision to have the important things that need to be always available running in my home, since they are doomed to experience downtime (power failures, ISP maintenance, and whatnot).</p>
<p>After deciding that I want my critical services (like <a href="https://docs.paperless-ngx.com/">paperless</a> for document management, <a href="https://nextcloud.com/">Nextcloud</a> for cloud storage, and <a href="https://immich.app/">Immich</a> for my photos and videos) to endure as little downtime as possible, I started looking for a relatively cheap solution - a VM and block storage.</p>
<p><a href="https://www.hetzner.com/">Hetzner</a> proved to be the the best solution I could find. They have unbeatable prices for ARM based VMs, and storage boxes that you can mount via CIFS, for as little as ~3€/mo.</p>
<p>I also took this opportunity to get more familiar with Terraform, and to build my infrastructure declaratively.</p>
<h2 id="using-terraform-to-provision-cloud-resources"><a class="zola-anchor" href="#using-terraform-to-provision-cloud-resources" aria-label="Anchor link for: using-terraform-to-provision-cloud-resources">Using Terraform to provision cloud resources</a></h2>
<p>After signing up to Hetzner, you'll need to log in to your cloud dashboard and create a project. A project is a separation that you can have between different, well, projects. This is a good time to pick a name for this rabbithole we're going down in.</p>
<p>Then, go ahead and generate an API token (under Security), name it <code>terraform</code>, and give it both read and write permissions.</p>
<p>Create a repository and inside a <code>terraform</code> directory. The <code>main.tf</code> file will look similar to this:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>terraform {
</span><span>  required_providers {
</span><span>    hcloud = {
</span><span>      source  = &quot;hetznercloud/hcloud&quot;
</span><span>      version = &quot;1.41.0&quot;
</span><span>    }
</span><span>  }
</span><span>}
</span><span>
</span><span>provider &quot;hcloud&quot; {
</span><span>  token = var.hcloud_token
</span><span>}
</span><span>
</span><span>resource &quot;hcloud_ssh_key&quot; &quot;personal&quot; {
</span><span>  name       = &quot;personal&quot;
</span><span>  public_key = file(var.ssh_public_key_path)
</span><span>}
</span><span>
</span><span>resource &quot;hcloud_firewall&quot; &quot;server&quot; {
</span><span>  name = &quot;crux-server-firewall&quot;
</span><span>  rule {
</span><span>    description = &quot;ssh&quot;
</span><span>    direction   = &quot;in&quot;
</span><span>    protocol    = &quot;tcp&quot;
</span><span>    port        = &quot;22&quot;
</span><span>    source_ips  = [&quot;0.0.0.0/0&quot;]
</span><span>  }
</span><span>  rule {
</span><span>    description = &quot;http&quot;
</span><span>    direction   = &quot;in&quot;
</span><span>    protocol    = &quot;tcp&quot;
</span><span>    port        = &quot;80&quot;
</span><span>    source_ips  = [&quot;0.0.0.0/0&quot;]
</span><span>  }
</span><span>  rule {
</span><span>    description = &quot;https&quot;
</span><span>    direction   = &quot;in&quot;
</span><span>    protocol    = &quot;tcp&quot;
</span><span>    port        = &quot;443&quot;
</span><span>    source_ips  = [&quot;0.0.0.0/0&quot;]
</span><span>  }
</span><span>}
</span><span>
</span><span>resource &quot;hcloud_server&quot; &quot;server&quot; {
</span><span>  name         = &quot;project-server&quot;
</span><span>  image        = &quot;ubuntu-22.04&quot;
</span><span>  server_type  = &quot;cax11&quot;
</span><span>  location     = &quot;fsn1&quot;
</span><span>  ssh_keys     = [hcloud_ssh_key.personal.id]
</span><span>  firewall_ids = [hcloud_firewall.server.id]
</span><span>
</span><span>  public_net {
</span><span>    ipv6_enabled = false
</span><span>  }
</span><span>}
</span><span>
</span><span>output &quot;server_ip&quot; {
</span><span>  value = hcloud_server.server.ipv4_address
</span><span>}
</span></code></pre>
<p>This file basically provisions your firewall and VM. In my case, I made sure to add my public SSH key to the VM so I can SSH into it as soon as it's done provisioning. I also opened ports 80 and 443 in the firewall so I can have my domain name pointing to the VM.</p>
<p>Make sure to change the values accordingly (such as the name and server type for your VM).</p>
<p>The other files you'll need is <code>variables.tf</code>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>variable &quot;hcloud_token&quot; {}
</span><span>
</span><span>variable &quot;ssh_public_key_path&quot; {
</span><span>  default = &quot;~/.ssh/personal.pub&quot;
</span><span>}
</span></code></pre>
<p><code>hcloud_token</code> is your API token, which will of course not be committed into your git repository, hence it's empty. When running Terraform, you can add a <code>--var-file=secrets.tfvars</code> which will point to a separate variables file that will contain the actual API token and will not be checked in to the repo.</p>
<p>In my setup, I also added the <code>remote-exec</code> and <code>local-exec</code> provisioners so it runs my Ansible playbook automatically after the VM is up, but I left it out as an exercise to the reader ™.</p>
<p>Now it should be as simple as running <code>terraform init</code> to initialize the directory, then <code>terraform plan</code> to view the planned changes, and <code>terraform apply --var-file=secrets.tfvars</code> to apply the changes and provision the resources.</p>
<h2 id="using-ansible-to-set-up-the-vm"><a class="zola-anchor" href="#using-ansible-to-set-up-the-vm" aria-label="Anchor link for: using-ansible-to-set-up-the-vm">Using Ansible to set up the VM</a></h2>
<p>I'm using Ansible to manage the configuration of my VM - my bash scripts, Docker compose files, cronjobs, packages, etc.</p>
<p>Create a directory named <code>ansible</code> next to the <code>terraform</code> directory. Inside it, create a playbook with a name of your choice (<code>site.yml</code>, <code>vm.yml</code>, or whatever):</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Configure VM
</span><span>  </span><span style="color:#bf616a;">hosts</span><span>: </span><span style="color:#a3be8c;">all
</span><span>  </span><span style="color:#bf616a;">gather_facts</span><span>: </span><span style="color:#d08770;">false
</span><span>  </span><span style="color:#bf616a;">become</span><span>: </span><span style="color:#d08770;">true
</span><span>  </span><span style="color:#bf616a;">roles</span><span>:
</span><span>    - </span><span style="color:#a3be8c;">vm
</span></code></pre>
<p>This basically calls the <code>vm</code> roles. Go ahead and create the following file: <code>roles/vm/tasks/main.yml</code></p>
<p>Now, it's really up to you to build this role to your liking and configure anything you dream of.
Me, personally? I use it to configure basic stuff (user, group, directories, packages), install Docker &amp; lazydocker, disable root &amp; password ssh authentication and so on.</p>
<p>Here are some useful tasks that you may find yourself using as well:</p>
<h3 id="configure-sshd"><a class="zola-anchor" href="#configure-sshd" aria-label="Anchor link for: configure-sshd">Configure sshd</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Configure sshd login
</span><span>  </span><span style="color:#bf616a;">lineinfile</span><span>:
</span><span>    </span><span style="color:#bf616a;">dest</span><span>: </span><span style="color:#a3be8c;">/etc/ssh/sshd_config
</span><span>    </span><span style="color:#bf616a;">regexp</span><span>: &#39;</span><span style="color:#a3be8c;">{{ item.regexp }}</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">line</span><span>: &#39;</span><span style="color:#a3be8c;">{{ item.line }}</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">present
</span><span>  </span><span style="color:#bf616a;">loop</span><span>:
</span><span>    - {</span><span style="color:#bf616a;">regexp</span><span>: </span><span style="color:#a3be8c;">^PermitRootLogin</span><span>, </span><span style="color:#bf616a;">line</span><span>: </span><span style="color:#a3be8c;">PermitRootLogin no</span><span>}
</span><span>    - {</span><span style="color:#bf616a;">regexp</span><span>: </span><span style="color:#a3be8c;">^PasswordAuthentication</span><span>, </span><span style="color:#bf616a;">line</span><span>: </span><span style="color:#a3be8c;">PasswordAuthentication no</span><span>}
</span><span>    - {</span><span style="color:#bf616a;">regexp</span><span>: </span><span style="color:#a3be8c;">^KbdInteractiveAuthentication</span><span>, </span><span style="color:#bf616a;">line</span><span>: </span><span style="color:#a3be8c;">KbdInteractiveAuthentication no</span><span>}
</span><span>
</span><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Restart SSH server
</span><span>  </span><span style="color:#bf616a;">service</span><span>:
</span><span>    </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">sshd
</span><span>    </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">restarted
</span></code></pre>
<h3 id="install-docker"><a class="zola-anchor" href="#install-docker" aria-label="Anchor link for: install-docker">Install Docker</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Check if Docker is installed
</span><span>  </span><span style="color:#bf616a;">command</span><span>: </span><span style="color:#a3be8c;">docker --version
</span><span>  </span><span style="color:#bf616a;">register</span><span>: </span><span style="color:#a3be8c;">docker_valid
</span><span>  </span><span style="color:#bf616a;">changed_when</span><span>: </span><span style="color:#d08770;">false
</span><span>  </span><span style="color:#bf616a;">ignore_errors</span><span>: </span><span style="color:#d08770;">true
</span><span>
</span><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Install Docker
</span><span>  </span><span style="color:#bf616a;">when</span><span>: </span><span style="color:#a3be8c;">docker_valid.failed
</span><span>  </span><span style="color:#bf616a;">block</span><span>:
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Install required system packages
</span><span>      </span><span style="color:#bf616a;">apt</span><span>:
</span><span>        </span><span style="color:#bf616a;">name</span><span>:
</span><span>          - </span><span style="color:#a3be8c;">ca-certificates
</span><span>          - </span><span style="color:#a3be8c;">curl
</span><span>          - </span><span style="color:#a3be8c;">gnupg
</span><span>          - </span><span style="color:#a3be8c;">lsb-release
</span><span>        </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">present
</span><span>        </span><span style="color:#bf616a;">update_cache</span><span>: </span><span style="color:#d08770;">true
</span><span>
</span><span>    </span><span style="color:#65737e;"># noqa yaml[line-length]
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Set up GPG key and repo
</span><span>      </span><span style="color:#bf616a;">shell</span><span>: </span><span style="color:#b48ead;">|
</span><span style="color:#a3be8c;">        mkdir -p /etc/apt/keyrings
</span><span style="color:#a3be8c;">        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
</span><span style="color:#a3be8c;">        echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
</span><span style="color:#a3be8c;">        https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;\
</span><span style="color:#a3be8c;">        | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span><span>      </span><span style="color:#bf616a;">tags</span><span>: </span><span style="color:#a3be8c;">skip_ansible_lint
</span><span>
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Install Docker packages
</span><span>      </span><span style="color:#bf616a;">apt</span><span>:
</span><span>        </span><span style="color:#bf616a;">name</span><span>:
</span><span>          - </span><span style="color:#a3be8c;">docker-ce
</span><span>          - </span><span style="color:#a3be8c;">docker-ce-cli
</span><span>          - </span><span style="color:#a3be8c;">containerd.io
</span><span>          - </span><span style="color:#a3be8c;">docker-compose-plugin
</span><span>        </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">present
</span><span>        </span><span style="color:#bf616a;">update_cache</span><span>: </span><span style="color:#d08770;">true
</span></code></pre>
<h3 id="install-lazydocker"><a class="zola-anchor" href="#install-lazydocker" aria-label="Anchor link for: install-lazydocker">Install lazydocker</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Check if lazydocker is installed
</span><span>  </span><span style="color:#bf616a;">command</span><span>: </span><span style="color:#a3be8c;">lazydocker --version
</span><span>  </span><span style="color:#bf616a;">register</span><span>: </span><span style="color:#a3be8c;">lazydocker_valid
</span><span>  </span><span style="color:#bf616a;">changed_when</span><span>: </span><span style="color:#d08770;">false
</span><span>  </span><span style="color:#bf616a;">ignore_errors</span><span>: </span><span style="color:#d08770;">true
</span><span>
</span><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Install lazydocker
</span><span>  </span><span style="color:#bf616a;">when</span><span>: </span><span style="color:#a3be8c;">lazydocker_valid.failed
</span><span>  </span><span style="color:#bf616a;">block</span><span>:
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Download lazydocker
</span><span>      </span><span style="color:#bf616a;">get_url</span><span>:
</span><span>        </span><span style="color:#bf616a;">url</span><span>: </span><span style="color:#a3be8c;">https://github.com/jesseduffield/lazydocker/releases/download/v0.23.1/lazydocker_0.23.1_Linux_arm64.tar.gz
</span><span>        </span><span style="color:#bf616a;">dest</span><span>: </span><span style="color:#a3be8c;">/tmp/lazydocker.tar.gz
</span><span>
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Extract lazydocker
</span><span>      </span><span style="color:#bf616a;">unarchive</span><span>:
</span><span>        </span><span style="color:#bf616a;">src</span><span>: </span><span style="color:#a3be8c;">/tmp/lazydocker.tar.gz
</span><span>        </span><span style="color:#bf616a;">dest</span><span>: </span><span style="color:#a3be8c;">/tmp
</span><span>        </span><span style="color:#bf616a;">remote_src</span><span>: </span><span style="color:#d08770;">true
</span><span>
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Copy lazydocker to /usr/local/bin
</span><span>      </span><span style="color:#bf616a;">copy</span><span>:
</span><span>        </span><span style="color:#bf616a;">src</span><span>: </span><span style="color:#a3be8c;">/tmp/lazydocker
</span><span>        </span><span style="color:#bf616a;">dest</span><span>: </span><span style="color:#a3be8c;">/usr/local/bin/lazydocker
</span><span>        </span><span style="color:#bf616a;">mode</span><span>: &#39;</span><span style="color:#a3be8c;">0755</span><span>&#39;
</span><span>        </span><span style="color:#bf616a;">remote_src</span><span>: </span><span style="color:#d08770;">true
</span><span>
</span><span>    - </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Remove temporary lazydocker files
</span><span>      </span><span style="color:#bf616a;">file</span><span>:
</span><span>        </span><span style="color:#bf616a;">path</span><span>: &#39;</span><span style="color:#a3be8c;">{{ item }}</span><span>&#39;
</span><span>        </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">absent
</span><span>      </span><span style="color:#bf616a;">loop</span><span>:
</span><span>        - </span><span style="color:#a3be8c;">/tmp/lazydocker.tar.gz
</span><span>        - </span><span style="color:#a3be8c;">/tmp/lazydocker
</span></code></pre>
<h3 id="synchronize-docker-compose-directory"><a class="zola-anchor" href="#synchronize-docker-compose-directory" aria-label="Anchor link for: synchronize-docker-compose-directory">Synchronize docker compose directory</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Synchronize stacks
</span><span>  </span><span style="color:#bf616a;">template</span><span>:
</span><span>    </span><span style="color:#bf616a;">src</span><span>: &#39;</span><span style="color:#a3be8c;">{{ item }}</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">dest</span><span>: &#39;</span><span style="color:#a3be8c;">/home/&lt;user&gt;/stacks/{{ item | basename }}</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">owner</span><span>: </span><span style="color:#a3be8c;">&lt;user&gt;
</span><span>    </span><span style="color:#bf616a;">mode</span><span>: &#39;</span><span style="color:#a3be8c;">0644</span><span>&#39;
</span><span>  </span><span style="color:#bf616a;">with_fileglob</span><span>:
</span><span>    - </span><span style="color:#a3be8c;">templates/stacks/*.yml
</span><span>  </span><span style="color:#bf616a;">tags</span><span>: </span><span style="color:#a3be8c;">stacks
</span></code></pre>
<h3 id="mount-hetzner-storage-box"><a class="zola-anchor" href="#mount-hetzner-storage-box" aria-label="Anchor link for: mount-hetzner-storage-box">Mount Hetzner Storage Box</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Create storage box mount directory
</span><span>  </span><span style="color:#bf616a;">file</span><span>:
</span><span>    </span><span style="color:#bf616a;">path</span><span>: </span><span style="color:#a3be8c;">/mnt/Storage
</span><span>    </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">directory
</span><span>    </span><span style="color:#bf616a;">owner</span><span>: </span><span style="color:#a3be8c;">&lt;user&gt;
</span><span>    </span><span style="color:#bf616a;">mode</span><span>: &#39;</span><span style="color:#a3be8c;">0755</span><span>&#39;
</span><span>
</span><span>- </span><span style="color:#bf616a;">name</span><span>: </span><span style="color:#a3be8c;">Mount storage box
</span><span>  </span><span style="color:#bf616a;">mount</span><span>:
</span><span>    </span><span style="color:#bf616a;">path</span><span>: </span><span style="color:#a3be8c;">/mnt/Storage
</span><span>    </span><span style="color:#bf616a;">src</span><span>: &#39;</span><span style="color:#a3be8c;">{{ hcloud_storage_box_path }}</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">fstype</span><span>: </span><span style="color:#a3be8c;">cifs
</span><span>    </span><span style="color:#bf616a;">opts</span><span>: &#39;</span><span style="color:#a3be8c;">iocharset=utf8,rw,user={{ hcloud_storage_box_username }},pass={{ hcloud_storage_box_password }},uid=1000,gid=1000,file_mode=0660,dir_mode=0770</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">state</span><span>: </span><span style="color:#a3be8c;">mounted
</span></code></pre>
<p>It's really handy to use ansible-vault to manage secret variables.</p>
<h2 id="crafting-docker-compose-files"><a class="zola-anchor" href="#crafting-docker-compose-files" aria-label="Anchor link for: crafting-docker-compose-files">Crafting Docker compose files</a></h2>
<p>Your next step will be to actually run the services you want. For that, you'll need Docker compose files. I like to keep them in the Ansible role <code>templates/stacks</code> directory, and use Ansible's templating engine to fill in secret variables such as tokens and passwords.</p>
<p>Here are some compose files that can come in handy (make sure to change the variables and volume mounts accordingly):</p>
<h3 id="nginx-proxy-manager"><a class="zola-anchor" href="#nginx-proxy-manager" aria-label="Anchor link for: nginx-proxy-manager">NGINX Proxy Manager</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">version</span><span>: &#39;</span><span style="color:#a3be8c;">3.8</span><span>&#39;
</span><span style="color:#bf616a;">services</span><span>:
</span><span>  </span><span style="color:#bf616a;">app</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: &#39;</span><span style="color:#a3be8c;">jc21/nginx-proxy-manager:latest</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">nginx-proxy-manager
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">unless-stopped
</span><span>    </span><span style="color:#bf616a;">network_mode</span><span>: </span><span style="color:#a3be8c;">host
</span><span>    </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">/home/&lt;user&gt;/volumes/nginx-proxy-manager/data:/data
</span><span>      - </span><span style="color:#a3be8c;">/home/&lt;user&gt;/volumes/nginx-proxy-manager/letsencrypt:/etc/letsencrypt
</span></code></pre>
<h3 id="nextcloud"><a class="zola-anchor" href="#nextcloud" aria-label="Anchor link for: nextcloud">Nextcloud</a></h3>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">version</span><span>: &#39;</span><span style="color:#a3be8c;">3.8</span><span>&#39;
</span><span style="color:#bf616a;">services</span><span>:
</span><span>  </span><span style="color:#bf616a;">mariadb</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">mariadb:10.6
</span><span>    </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">nextcloud-mariadb
</span><span>    </span><span style="color:#bf616a;">command</span><span>: </span><span style="color:#a3be8c;">--transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">unless-stopped
</span><span>    </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">/home/&lt;user&gt;/volumes/nextcloud/mariadb:/var/lib/mysql:Z
</span><span>    </span><span style="color:#bf616a;">environment</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">MYSQL_ROOT_PASSWORD={{ nextcloud_mysql_password }}
</span><span>      - </span><span style="color:#a3be8c;">MYSQL_PASSWORD={{ nextcloud_mysql_password }}
</span><span>      - </span><span style="color:#a3be8c;">MYSQL_DATABASE=nextcloud
</span><span>      - </span><span style="color:#a3be8c;">MYSQL_USER=nextcloud
</span><span>      - </span><span style="color:#a3be8c;">MARIADB_AUTO_UPGRADE=1
</span><span>      - </span><span style="color:#a3be8c;">MARIADB_DISABLE_UPGRADE_BACKUP=1
</span><span>
</span><span>  </span><span style="color:#bf616a;">redis</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">redis:alpine
</span><span>    </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">nextcloud-redis
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">unless-stopped
</span><span>
</span><span>  </span><span style="color:#bf616a;">nextcloud</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">lscr.io/linuxserver/nextcloud:latest
</span><span>    </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">nextcloud
</span><span>    </span><span style="color:#bf616a;">environment</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">PUID=1000
</span><span>      - </span><span style="color:#a3be8c;">PGID=1000
</span><span>      - </span><span style="color:#a3be8c;">TZ=&lt;timezone&gt;
</span><span>    </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">/home/&lt;user&gt;/volumes/nextcloud:/config
</span><span>      - </span><span style="color:#a3be8c;">/mnt/&lt;nextcloud dir&gt;:/data
</span><span>    </span><span style="color:#bf616a;">ports</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">8082:443
</span><span>    </span><span style="color:#bf616a;">depends_on</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">mariadb
</span><span>      - </span><span style="color:#a3be8c;">redis
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">unless-stopped
</span></code></pre>
<h3 id="accessing-the-vm-from-outside"><a class="zola-anchor" href="#accessing-the-vm-from-outside" aria-label="Anchor link for: accessing-the-vm-from-outside">Accessing the VM from outside</a></h3>
<p>The safest option to access your VM from outside the cloud network is using a VPN. You can self host Wireguard with <code>wg-easy</code> or use Tailscale (recommended).</p>
<p>If you want your services to be publicly accessible, you'll need to set up a reverse proxy which will map subdomains to your services which are exposed on certain ports (for example, to access your Nextcloud instance, you'll visit <code>nextcloud.mylab.com</code> instead of <code>mylab.com:8082</code>).</p>
<p>I do a mix of both. I like using Tailscale to access services that I don't need exposed to the internet, and that I don't mind connecting to the VPN for, like Netdata, and I use Nginx Proxy Manager as a reverse proxy for other services that I want to access from anywhere without a VPN.</p>
<p>FYI, there are other solutions which I won't cover here like Cloudflare tunnels. Do your research if this seems right for you.</p>
<h4 id="reverse-proxy"><a class="zola-anchor" href="#reverse-proxy" aria-label="Anchor link for: reverse-proxy">Reverse proxy</a></h4>
<p>First you'll need to purchase a domain. I recommend heading over to <a href="https://tld-list.com/">TLD-List</a> to look for a cheap TLD (you probably don't need <code>.com</code> or <code>.ai</code> for your cheap lab).</p>
<p>After that, I like to change the DNS nameserver for the domain from the domain registrar's to Cloudflare, simply because I like their UI and their API.</p>
<p>Set an A record for <code>@</code> (root) to your VM's IP address, and set a CNAME record for <code>*</code> to point to <code>@</code>, so any subdomain will also point to the VM.</p>
<p>Then in your reverse proxy of choice, you can map each subdomain you want to a service, along with an SSL certificate.</p>
<h2 id="final-words"><a class="zola-anchor" href="#final-words" aria-label="Anchor link for: final-words">Final words</a></h2>
<p>I hope you found this writeup useful. I tried to only write about the general gist of things without going into many details, but also without being too brisk and missing critical points. Self-hosting can be intimidating at first, but once you experiment with it, and try things out, it's not too scary.</p>

        </section>
    </article>
</main>



        
            
        

        
    </div>
</body>

</html>
