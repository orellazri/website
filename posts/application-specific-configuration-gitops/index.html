<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  
  
    
  
  <meta name="description" content="">

  <title>Application Specific Configuration with GitOps Deployments</title>
  <link rel="icon" type="image/png" sizes="32x32" href="https://orellazri.com/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://orellazri.com/img/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://orellazri.com/img/apple-touch-icon.png">
  <style>
@font-face {
  font-display: swap;
  font-family: 'Piazzolla';
  font-style: normal;
  font-weight: 400;
  src: url('/font/Piazzolla.woff2') format('woff2');
}
</style>

  <style>

  /* light mode colors */
  body {
    --primary-color: #5871a2;
    --primary-pale-color: #5871a233;
    --primary-decoration-color: #5871a210;
    --bg-color: #ffffff;
    --text-color: #2f3030;
    --text-pale-color: #767676;
    --text-decoration-color: #a9a9a9;
    --highlight-mark-color: #5f75b020;

    --callout-note-color: #5871a2;
    --callout-tip-color: #268556;
    --callout-important-color: #885fc9;
    --callout-warning-color: #ab6632;
    --callout-caution-color: #c64e4e;
  }

  /* dark mode colors */
  body.dark {
    --primary-color: #6f8fd1;
    --primary-pale-color: #6f8fd166;
    --primary-decoration-color: #6f8fd112;
    --bg-color: #2b2b38;
    --text-color: #c1c1c1;
    --text-pale-color: #848484;
    --text-decoration-color: #5f5f5f;
    --highlight-mark-color: #8296cb3b;

    --callout-note-color: #6f8fd1;
    --callout-tip-color: #47976f;
    --callout-important-color: #9776cd;
    --callout-warning-color: #ad7a52;
    --callout-caution-color: #d06161;
  }

  /* typography */
  body {
    --main-font: 'Piazzolla', serif;
    --code-font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
    --homepage-max-width: 768px;
    --main-max-width: 768px;
    --avatar-size: 50px;
    --font-size: 17px;
    --line-height: 1.75;
    --img-border-radius: 0px;
    --detail-border-radius: 0px;
    --dark-mode-img-brightness: 0.75;
    --dark-mode-chart-brightness: 0.75;
    --inline-code-border-radius: 2px;
    --inline-code-bg-color: var(--primary-decoration-color);
    --block-code-border-radius: 0px;
    --block-code-border-color: var(--primary-color);
    --detail-border-color: var(--primary-color);
  }

</style>

  <link rel="stylesheet" href="https://orellazri.com/main.css">
  

<link id="hl" rel="stylesheet" type="text/css" href="/giallo-dark.css" />



  <script data-goatcounter="https://orellazri.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>

</head>

<body class="post dark">
  
  
<div id="wrapper">
  <div id="blank"></div>
  <aside>
    
    
    <nav>
      <ul>
        
        <li>
          <a class="h2" href="#understanding-the-setup">Understanding the Setup</a>
          
        </li>
        
        <li>
          <a class="h2" href="#benefits-of-managing-configurations-alongside-code">Benefits of Managing Configurations Alongside Code</a>
          
        </li>
        
        <li>
          <a class="h2" href="#automating-configmap-patching">Automating ConfigMap Patching</a>
          
        </li>
        
      </ul>
    </nav>
    
    
    <button id="back-to-top" aria-label="back to top">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>

    </button>
    
  </aside>
  <main>
    
<header>
  <nav>
    <a id="back-link" href="https:&#x2F;&#x2F;orellazri.com&#x2F;posts">‚Üê Back</a>
  </nav>
</header>


    <div>
      
      
      
      
      <div id="copy-cfg" style="display: none;" data-copy-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
" data-check-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
"></div>
      
      <article class="prose">
        <h1>Application Specific Configuration with GitOps Deployments</h1>
        <div id="post-info">
          <div id="date">
            <span id="publish">Apr 28, 2024</span>
            </div>

          
          <div id="tags">
            <a class="instant" href="https://orellazri.com/tags/devops"><span>#</span>devops</a>
          </div>
          
        </div>

        
        

        

        <p>In today's fast-paced software development landscape, staying agile and efficient is crucial. One area where efficiency matters greatly is in deploying application configurations. Developers often need to make changes to configuration values based on different environments, like production, staging, or development.</p>
<h2 id="understanding-the-setup">Understanding the Setup<a class="zola-anchor" href="#understanding-the-setup" aria-label="Anchor link for: understanding-the-setup" style="visibility: hidden;"></a>
</h2>
<p>At the core of this approach is the idea of storing application configuration values directly within the application's repository. You create YAML files for each environment, like <code>prod.yml</code> or <code>sandbox.yml</code>, and populate them with the necessary key-value pairs for different configurations.</p>
<p>These key-value pairs will then be used to update the relevant ConfigMap file in the GitOps repository.</p>
<p>Example of a configuration yaml file:</p>
<pre class="giallo z-code"><code data-lang="yaml"><span class="giallo-l"><span class="z-entity z-name z-tag">f</span><span class="z-entity z-name z-tag">oo</span><span>:</span><span class="z-string"> b</span><span class="z-string">ar</span></span></code></pre>
<p>Example of the resulting ConfigMap in the GitOps repository (after the data has been updated):</p>
<pre class="giallo z-code"><code data-lang="yaml"><span class="giallo-l"><span class="z-entity z-name z-tag">a</span><span class="z-entity z-name z-tag">piVersion</span><span>:</span><span class="z-string"> v</span><span class="z-string">1</span></span>
<span class="giallo-l"><span class="z-entity z-name z-tag">k</span><span class="z-entity z-name z-tag">ind</span><span>:</span><span class="z-string"> C</span><span class="z-string">onfigMap</span></span>
<span class="giallo-l"><span class="z-entity z-name z-tag">m</span><span class="z-entity z-name z-tag">etadata</span><span>:</span></span>
<span class="giallo-l"><span class="z-entity z-name z-tag">  n</span><span class="z-entity z-name z-tag">ame</span><span>:</span><span class="z-string"> a</span><span class="z-string">pplication-cm</span></span>
<span class="giallo-l"><span class="z-entity z-name z-tag">d</span><span class="z-entity z-name z-tag">ata</span><span>:</span></span>
<span class="giallo-l"><span class="z-entity z-name z-tag">  f</span><span class="z-entity z-name z-tag">oo</span><span>:</span><span class="z-string"> b</span><span class="z-string">ar</span></span></code></pre><h2 id="benefits-of-managing-configurations-alongside-code">Benefits of Managing Configurations Alongside Code<a class="zola-anchor" href="#benefits-of-managing-configurations-alongside-code" aria-label="Anchor link for: benefits-of-managing-configurations-alongside-code" style="visibility: hidden;"></a>
</h2>
<p>The beauty of this approach is that it puts the power in the hands of developers. They can make changes to application-specific configurations directly in the repository without needing approval from DevOps teams. This speeds up the development cycle and allows teams to respond quickly to evolving requirements.</p>
<h2 id="automating-configmap-patching">Automating ConfigMap Patching<a class="zola-anchor" href="#automating-configmap-patching" aria-label="Anchor link for: automating-configmap-patching" style="visibility: hidden;"></a>
</h2>
<p>To automate this process, we can use a script that scans for YAML files within a <code>deployment-configs</code> directory in the application repository. If it finds any, it updates the corresponding <code>application_configmap.yml</code> file in the GitOps repository with the data from these YAML files. This means that any changes made to the YAML files in the application repository are automatically reflected in the GitOps repository, simplifying the deployment process significantly.</p>
<pre class="giallo z-code"><code data-lang="shellscript"><span class="giallo-l"><span class="z-punctuation z-definition z-comment">#!</span><span class="z-comment">/usr/bin/env bash</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">if</span><span> [</span><span class="z-keyword"> -d</span><span> deployment-configs </span><span>]</span><span>;</span><span class="z-keyword"> then</span></span>
<span class="giallo-l"><span class="z-support">    echo</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-string">Found deployment-configs directory</span><span class="z-punctuation z-definition z-string">&quot;</span></span>
<span class="giallo-l"><span class="z-variable z-other">    config_files</span><span class="z-keyword">=</span><span>$(</span><span class="z-entity z-name">find</span><span class="z-string"> deployment-configs</span><span class="z-constant"> -</span><span class="z-constant">maxdepth</span><span class="z-constant"> 1</span><span class="z-constant"> -</span><span class="z-constant">type</span><span class="z-string"> f</span><span class="z-constant"> \(</span><span class="z-constant"> -</span><span class="z-constant">iname</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-variable z-other">$</span><span class="z-variable z-other">ENV</span><span class="z-string">.yml</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-constant"> -</span><span class="z-constant">o</span><span class="z-constant"> -</span><span class="z-constant">iname</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-variable z-other">$</span><span class="z-variable z-other">ENV</span><span class="z-string">.yaml</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-constant"> \)</span><span>)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">    for</span><span class="z-variable z-other"> file</span><span class="z-keyword"> in</span><span class="z-constant"> \$</span><span class="z-string">c</span><span class="z-string">o</span><span class="z-string">n</span><span class="z-string">f</span><span class="z-string">i</span><span class="z-string">g</span><span class="z-string">_</span><span class="z-string">f</span><span class="z-string">i</span><span class="z-string">l</span><span class="z-string">e</span><span class="z-string">s</span><span>;</span><span class="z-keyword"> do</span></span>
<span class="giallo-l"><span class="z-support">        echo</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-string">Found </span><span class="z-constant">\$</span><span class="z-string">file</span><span class="z-punctuation z-definition z-string">&quot;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-variable z-other">        gitops_configmap_path</span><span class="z-keyword">=</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-string">gitops-deployments/.../envs/</span><span class="z-variable z-other">$</span><span class="z-variable z-other">ENV</span><span class="z-string">/application_configmap.yml</span><span class="z-punctuation z-definition z-string">&quot;</span></span>
<span class="giallo-l"><span class="z-keyword">        if</span><span> [</span><span class="z-keyword"> -f</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-constant">\$</span><span class="z-string">gitops_configmap_path</span><span class="z-punctuation z-definition z-string">&quot;</span><span> ]</span><span>;</span><span class="z-keyword"> then</span></span>
<span class="giallo-l"><span class="z-support">            echo</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-string">Patching </span><span class="z-constant">\$</span><span class="z-string">gitops_configmap_path</span><span class="z-punctuation z-definition z-string">&quot;</span></span>
<span class="giallo-l"><span class="z-entity z-name">            yq</span><span class="z-constant"> -</span><span class="z-constant">i</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-string">.data = load(</span><span class="z-constant">\&quot;</span><span class="z-constant">\$</span><span class="z-string">file</span><span class="z-constant">\&quot;</span><span class="z-string">)</span><span class="z-punctuation z-definition z-string">&quot;</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-constant">\$</span><span class="z-string">gitops_configmap_path</span><span class="z-punctuation z-definition z-string">&quot;</span></span>
<span class="giallo-l"><span class="z-keyword">        fi</span></span>
<span class="giallo-l"><span class="z-keyword">    done</span></span>
<span class="giallo-l"><span class="z-keyword">fi</span></span></code></pre>
<p>This script assumes that <code>yq</code> is installed and that an environment variable named <code>ENV</code> exists and is set to the desired environment (e.g., <code>prod</code>, <code>staging</code>). This should be defined in the relevant CI step.</p>
<p>This will effectily update the ConfigMap in the GitOps repository with the values from the YAML files in the application repository.</p>

      </article>

      
      

      
      
    </div>

    


<footer>
  <div class="left">
    <div class="copyright">
      
      
    </div>
  </div>

  <div class="right">
    
    
      
    
    
    <a id="rss-btn" href="https://orellazri.com/atom.xml">RSS</a>
    
    

    
  </div>
</footer>




<dialog id="rss-mask">
  <div>
    <a href="https:&#x2F;&#x2F;orellazri.com&#x2F;atom.xml">https:&#x2F;&#x2F;orellazri.com&#x2F;atom.xml</a>
    
    
    <button autofocus aria-label="copy" data-link="https:&#x2F;&#x2F;orellazri.com&#x2F;atom.xml" data-copy-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
" data-check-icon="&lt;svg xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; viewBox=&quot;0 0 24 24&quot; width=&quot;18&quot; height=&quot;18&quot;&gt;&lt;path d=&quot;M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z&quot; fill=&quot;currentColor&quot;&gt;&lt;&#x2F;path&gt;&lt;&#x2F;svg&gt;
" >
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>

    </button>
  </div>
</dialog>



  </main>
</div>

  
<script src="/js/lightense.min.js"></script>


  <script src="https://orellazri.com/js/main.js"></script>
</body>

</html>
